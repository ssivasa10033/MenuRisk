{% extends "base.html" %}

{% block title %}Dashboard - Menu Portfolio Optimizer{% endblock %}

{% block content %}
<div class="row">
    <!-- Upload Section -->
    <div class="col-lg-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Upload Menu Data</h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="upload-area" id="dropZone">
                        <i class="bi bi-cloud-upload" style="font-size: 3rem; color: #bdc3c7;"></i>
                        <p class="mt-3">Drag & drop your CSV file here or click to browse</p>
                        <input type="file" id="fileInput" name="file" accept=".csv" style="display: none;">
                        <button type="button" class="btn btn-primary mt-2" onclick="document.getElementById('fileInput').click()">
                            Select File
                        </button>
                    </div>
                    <div id="fileInfo" class="mt-3" style="display: none;">
                        <p><strong>Selected file:</strong> <span id="fileName"></span></p>
                        <button type="submit" class="btn btn-success">Analyze Data</button>
                    </div>
                </form>
                <div id="uploadProgress" class="mt-3" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%">
                            Analyzing...
                        </div>
                    </div>
                </div>
                <div id="uploadError" class="alert alert-danger mt-3" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

{% if results %}
<!-- Results Section -->
<div class="row">
    <!-- Model Metrics -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Model Performance</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6 metric-card">
                        <div class="metric-value">{{ "%.2f"|format(results.metrics.r2_score * 100) }}%</div>
                        <div class="metric-label">R-Squared Score</div>
                    </div>
                    <div class="col-6 metric-card">
                        <div class="metric-value">{{ "%.4f"|format(results.metrics.mae) }}</div>
                        <div class="metric-label">Mean Absolute Error</div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-6 metric-card">
                        <div class="metric-value">{{ "%.2f"|format(results.metrics.cv_r2_mean * 100) }}%</div>
                        <div class="metric-label">CV R-Squared Mean</div>
                    </div>
                    <div class="col-6 metric-card">
                        <div class="metric-value">{{ "%.4f"|format(results.metrics.rmse) }}</div>
                        <div class="metric-label">RMSE</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Portfolio Metrics -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Portfolio Analysis</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6 metric-card">
                        <div class="metric-value">{{ "%.2f"|format(results.portfolio.sharpe_ratio) }}</div>
                        <div class="metric-label">Sharpe Ratio</div>
                    </div>
                    <div class="col-6 metric-card">
                        <div class="metric-value">{{ results.portfolio.num_items }}</div>
                        <div class="metric-label">Items Analyzed</div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-6 metric-card">
                        <div class="metric-value">{{ "%.2f"|format(results.portfolio.mean_return * 100) }}%</div>
                        <div class="metric-label">Mean Return</div>
                    </div>
                    <div class="col-6 metric-card">
                        <div class="metric-value">{{ "%.2f"|format(results.portfolio.volatility * 100) }}%</div>
                        <div class="metric-label">Volatility</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
{% if results.charts %}
<div class="row mt-4">
    <div class="col-lg-6">
        <div class="chart-container">
            <h6>Model Performance</h6>
            <img src="{{ url_for('static', filename='charts/model_performance.png') }}" class="img-fluid" alt="Model Performance">
        </div>
    </div>
    <div class="col-lg-6">
        <div class="chart-container">
            <h6>Feature Importance</h6>
            <img src="{{ url_for('static', filename='charts/feature_importance.png') }}" class="img-fluid" alt="Feature Importance">
        </div>
    </div>
</div>
<div class="row">
    <div class="col-lg-6">
        <div class="chart-container">
            <h6>Portfolio Metrics</h6>
            <img src="{{ url_for('static', filename='charts/portfolio_metrics.png') }}" class="img-fluid" alt="Portfolio Metrics">
        </div>
    </div>
    <div class="col-lg-6">
        <div class="chart-container">
            <h6>Category Analysis</h6>
            <img src="{{ url_for('static', filename='charts/category_analysis.png') }}" class="img-fluid" alt="Category Analysis">
        </div>
    </div>
</div>
{% endif %}

<!-- Recommendations Table -->
{% if results.recommendations %}
<div class="row mt-4">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Item Recommendations</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>Recommendation</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item, rec in results.recommendations.items() %}
                            <tr>
                                <td>{{ item }}</td>
                                <td class="recommendation-{{ rec }}">
                                    <strong>{{ rec|upper }}</strong>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% else %}
<!-- No Results Yet -->
<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <h4>Welcome to Menu Portfolio Optimizer</h4>
                <p class="text-muted">Upload your menu data CSV to get started with the analysis.</p>
                <p>Required columns: <code>item_name</code>, <code>current_price</code>, <code>cogs</code>, <code>quantity_sold</code></p>
                <p>Optional columns: <code>category</code>, <code>season</code>, <code>province</code></p>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const uploadForm = document.getElementById('uploadForm');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadError = document.getElementById('uploadError');

    // Drag and drop handlers
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#3498db';
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.style.borderColor = '#bdc3c7';
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#bdc3c7';
        if (e.dataTransfer.files.length) {
            fileInput.files = e.dataTransfer.files;
            showFileInfo(e.dataTransfer.files[0]);
        }
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
            showFileInfo(e.target.files[0]);
        }
    });

    function showFileInfo(file) {
        fileName.textContent = file.name;
        fileInfo.style.display = 'block';
    }

    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        uploadProgress.style.display = 'block';
        uploadError.style.display = 'none';

        try {
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                window.location.reload();
            } else {
                uploadError.textContent = data.error || 'Upload failed';
                uploadError.style.display = 'block';
            }
        } catch (error) {
            uploadError.textContent = 'Network error: ' + error.message;
            uploadError.style.display = 'block';
        } finally {
            uploadProgress.style.display = 'none';
        }
    });
</script>
{% endblock %}
